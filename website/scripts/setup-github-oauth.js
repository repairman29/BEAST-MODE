#!/usr/bin/env node

/**
 * Setup GitHub OAuth Configuration
 * 
 * Stores GitHub OAuth credentials in Supabase and updates .env.local
 */

const fs = require('fs');
const path = require('path');
const { createClient } = require('@supabase/supabase-js');

// Use unified config if available
let getUnifiedConfig = null;
try {
  const configPath = path.join(__dirname, '../../shared-utils/unified-config');
  const unifiedConfig = require(configPath);
  getUnifiedConfig = unifiedConfig.getUnifiedConfig;
} catch (error) {
  // Unified config not available
}

// Helper function to get config value
async function getConfigValue(key, defaultValue = null) {
  if (getUnifiedConfig) {
    try {
      const config = await getUnifiedConfig();
      const value = config.get(key);
      if (value !== null && value !== undefined && value !== '') {
        return value;
      }
    } catch (error) {
      // Fallback to process.env
    }
  }
  // Fallback to process.env for backward compatibility
  return process.env[key] !== undefined && process.env[key] !== '' ? process.env[key] : defaultValue;
}

const GITHUB_CLIENT_ID = 'Ov23lidLvmp68FVMEqEB';
const GITHUB_CLIENT_SECRET = 'df4c598018de45ce8cb90313489eeb21448aedcf';
const GITHUB_TOKEN_ENCRYPTION_KEY = '20abb6f3b973e2fdeea6e2c417ce93824e7b64962f9fee4bfd6339264c8e792c';

async function setupSupabase() {
  const supabaseUrl = await getConfigValue('NEXT_PUBLIC_SUPABASE_URL', null);
  const supabaseServiceKey = await getConfigValue('SUPABASE_SERVICE_ROLE_KEY', null);

  if (!supabaseUrl || !supabaseServiceKey) {
    console.log('âš ï¸  Supabase not configured - skipping database setup');
    console.log('   Set NEXT_PUBLIC_SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY to enable');
    return false;
  }

  try {
    const supabase = createClient(supabaseUrl, supabaseServiceKey);

    // Check if app_config table exists, create if not
    const { error: checkError } = await supabase
      .from('app_config')
      .select('key')
      .limit(1);

    if (checkError && checkError.code === 'PGRST116') {
      console.log('ğŸ“‹ Creating app_config table in Supabase...');
      // Table doesn't exist - would need to create via migration
      console.log('   Run this SQL in Supabase SQL Editor:');
      console.log(`
CREATE TABLE IF NOT EXISTS app_config (
  key TEXT PRIMARY KEY,
  value JSONB NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_app_config_key ON app_config(key);
      `);
      return false;
    }

    // Get config values
    const GITHUB_REDIRECT_URI = await getConfigValue('GITHUB_REDIRECT_URI', 'http://localhost:7777/api/github/oauth/callback');

    // Store GitHub OAuth config
    const { data, error } = await supabase
      .from('app_config')
      .upsert({
        key: 'github_oauth',
        value: {
          client_id: GITHUB_CLIENT_ID,
          client_secret: GITHUB_CLIENT_SECRET,
          redirect_uri: GITHUB_REDIRECT_URI,
          encryption_key: GITHUB_TOKEN_ENCRYPTION_KEY,
        },
        updated_at: new Date().toISOString(),
      }, {
        onConflict: 'key'
      })
      .select()
      .single();

    if (error) {
      console.error('âŒ Error storing in Supabase:', error.message);
      return false;
    }

    console.log('âœ… GitHub OAuth config stored in Supabase');
    return true;
  } catch (error) {
    console.error('âŒ Supabase setup error:', error.message);
    return false;
  }
}

async function setupEnvLocal() {
  // Get config values
  const GITHUB_REDIRECT_URI = await getConfigValue('GITHUB_REDIRECT_URI', 'http://localhost:7777/api/github/oauth/callback');
  const NEXT_PUBLIC_URL = await getConfigValue('NEXT_PUBLIC_URL', 'http://localhost:7777');

  const envPath = path.join(__dirname, '..', '.env.local');
  const envContent = `# BEAST MODE Environment Variables
# Generated by setup-github-oauth.js

# GitHub OAuth (for private repo scanning)
GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID}
GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}
GITHUB_REDIRECT_URI=${GITHUB_REDIRECT_URI}

# Token Encryption Key
GITHUB_TOKEN_ENCRYPTION_KEY=${GITHUB_TOKEN_ENCRYPTION_KEY}

# App URL
NEXT_PUBLIC_URL=${NEXT_PUBLIC_URL}

# For production, update:
# GITHUB_REDIRECT_URI=https://beast-mode.dev/api/github/oauth/callback
# NEXT_PUBLIC_URL=https://beast-mode.dev
`;

  try {
    // Read existing .env.local if it exists
    let existingContent = '';
    if (fs.existsSync(envPath)) {
      existingContent = fs.readFileSync(envPath, 'utf8');
    }

    // Merge with existing content (don't overwrite other vars)
    const lines = existingContent.split('\n');
    const newLines = envContent.split('\n');
    const merged = new Set();

    // Add existing lines (except GitHub OAuth vars)
    lines.forEach(line => {
      if (line.trim() && !line.includes('GITHUB_CLIENT_ID') && 
          !line.includes('GITHUB_CLIENT_SECRET') && 
          !line.includes('GITHUB_REDIRECT_URI') &&
          !line.includes('GITHUB_TOKEN_ENCRYPTION_KEY') &&
          !line.includes('NEXT_PUBLIC_URL')) {
        merged.add(line);
      }
    });

    // Add new GitHub OAuth vars
    newLines.forEach(line => {
      if (line.trim() && (line.includes('GITHUB_') || line.includes('NEXT_PUBLIC_URL'))) {
        merged.add(line);
      }
    });

    const finalContent = Array.from(merged).join('\n') + '\n';
    fs.writeFileSync(envPath, finalContent, 'utf8');
    console.log('âœ… Updated .env.local with GitHub OAuth credentials');
    return true;
  } catch (error) {
    console.error('âŒ Error updating .env.local:', error.message);
    return false;
  }
}

async function main() {
  console.log('ğŸš€ Setting up GitHub OAuth Configuration...\n');

  // Setup Supabase
  await setupSupabase();

  // Setup .env.local
  await setupEnvLocal();

  console.log('\nâœ… Setup complete!');
  console.log('\nğŸ“‹ Next steps:');
  console.log('   1. If Supabase table needed, run the SQL from above');
  console.log('   2. Restart dev server: npm run dev');
  console.log('   3. Test GitHub connection in Settings tab');
}

main().catch(console.error);

