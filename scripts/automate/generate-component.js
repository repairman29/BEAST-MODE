#!/usr/bin/env node

/**
 * Auto-Generate Component Boilerplate
 * Uses BEAST MODE to generate React/Next.js components
 */

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

const COMPONENT_TEMPLATE = `"use client";

import React from 'react';

interface {{COMPONENT_NAME}}Props {
  // Add props here
}

/**
 * {{COMPONENT_NAME}} Component
 * Auto-generated by BEAST MODE
 */
export default function {{COMPONENT_NAME}}(props: {{COMPONENT_NAME}}Props) {
  return (
    <div className="{{component-name}}">
      <h2>{{COMPONENT_NAME}}</h2>
      {/* Add component content */}
    </div>
  );
}
`;

const TEST_TEMPLATE = `import { render, screen } from '@testing-library/react';
import {{COMPONENT_NAME}} from './{{COMPONENT_NAME}}';

describe('{{COMPONENT_NAME}}', () => {
  it('renders correctly', () => {
    render(<{{COMPONENT_NAME}} />);
    expect(screen.getByText('{{COMPONENT_NAME}}')).toBeInTheDocument();
  });
});
`;

function generateComponent(componentName, options = {}) {
  const { 
    type = 'component',
    directory = 'website/components',
    generateTest = true,
    useBeastMode = false
  } = options;

  console.log(`üöÄ Generating ${type}: ${componentName}`);
  console.log('============================================================\n');

  // Validate component name
  if (!componentName || !/^[A-Z][a-zA-Z0-9]*$/.test(componentName)) {
    console.error('‚ùå Invalid component name. Must start with uppercase letter.');
    process.exit(1);
  }

  const componentDir = path.join(__dirname, '../..', directory, componentName);
  const componentFile = path.join(componentDir, `${componentName}.tsx`);
  const testFile = path.join(componentDir, `${componentName}.test.tsx`);

  // Create directory
  fs.mkdirSync(componentDir, { recursive: true });

  // Generate component
  let componentCode = COMPONENT_TEMPLATE
    .replace(/\{\{COMPONENT_NAME\}\}/g, componentName)
    .replace(/\{\{component-name\}\}/g, componentName.toLowerCase());

  // Use BEAST MODE to enhance if requested
  if (useBeastMode) {
    try {
      const response = execSync(
        `curl -s -X POST http://localhost:3000/api/codebase/chat -H "Content-Type: application/json" -d '{"sessionId":"generate-${componentName}","message":"Enhance this component with proper TypeScript types, error handling, and best practices: ${componentCode}","repo":"BEAST-MODE-PRODUCT"}'`,
        { encoding: 'utf8', maxBuffer: 10 * 1024 * 1024 }
      );
      const result = JSON.parse(response);
      if (result.code) {
        componentCode = result.code;
        console.log('   ‚ú® Enhanced with BEAST MODE');
      }
    } catch (error) {
      console.warn('   ‚ö†Ô∏è  BEAST MODE enhancement failed, using template');
    }
  }

  fs.writeFileSync(componentFile, componentCode);
  console.log(`   ‚úÖ Created: ${componentFile}`);

  // Generate test
  if (generateTest) {
    const testCode = TEST_TEMPLATE
      .replace(/\{\{COMPONENT_NAME\}\}/g, componentName);
    
    fs.writeFileSync(testFile, testCode);
    console.log(`   ‚úÖ Created: ${testFile}`);
  }

  // Generate index file
  const indexFile = path.join(componentDir, 'index.ts');
  fs.writeFileSync(indexFile, `export { default } from './${componentName}';\n`);
  console.log(`   ‚úÖ Created: ${indexFile}`);

  console.log(`\n‚úÖ ${componentName} generated successfully!`);
  console.log(`\nüìã Next Steps:`);
  console.log(`   1. Edit ${componentFile}`);
  console.log(`   2. Add your component logic`);
  console.log(`   3. Run tests: npm test ${componentName}`);
}

// CLI
const componentName = process.argv[2];
const useBeastMode = process.argv.includes('--beast-mode') || process.argv.includes('-b');

if (!componentName) {
  console.log('Usage: node scripts/automate/generate-component.js <ComponentName> [--beast-mode]');
  console.log('\nExample:');
  console.log('  node scripts/automate/generate-component.js UserProfile');
  console.log('  node scripts/automate/generate-component.js UserProfile --beast-mode');
  process.exit(1);
}

generateComponent(componentName, { useBeastMode });
