name: Quality Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'

jobs:
  quality-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check Repository Quality
        id: quality
        run: |
          REPO="${{ github.repository }}"
          QUALITY_RESPONSE=$(curl -s -X POST "${{ secrets.BEAST_MODE_API || 'https://beast-mode.com' }}/api/repos/quality" \
            -H "Content-Type: application/json" \
            -d "{\"repo\": \"$REPO\", \"platform\": \"github-actions\"}")
          
          QUALITY=$(echo $QUALITY_RESPONSE | jq -r '.quality * 100')
          QUALITY_ID=$(echo $QUALITY_RESPONSE | jq -r '.predictionId')
          
          echo "quality=$QUALITY" >> $GITHUB_OUTPUT
          echo "quality_id=$QUALITY_ID" >> $GITHUB_OUTPUT
          echo "Quality Score: $QUALITY%"
      
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const quality = '${{ steps.quality.outputs.quality }}';
            const qualityId = '${{ steps.quality.outputs.quality_id }}';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ“Š Quality Check Results
              
              **Quality Score:** ${quality}%
              
              [View Full Report](${{ secrets.BEAST_MODE_API || 'https://beast-mode.com' }}/quality?repo=${{ github.repository }})
              
              [Provide Feedback](https://beast-mode.com/feedback?predictionId=${qualityId})
              `
            });
      
      - name: Fail if Quality Below Threshold
        if: steps.quality.outputs.quality < 60
        run: |
          echo "âŒ Quality score (${{ steps.quality.outputs.quality }}%) is below threshold (60%)"
          exit 1
