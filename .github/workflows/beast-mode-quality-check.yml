name: BEAST MODE Quality Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, master]

jobs:
  quality-check:
    runs-on: ubuntu-latest
    name: Code Quality Analysis
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for PR comparison
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run BEAST MODE Quality Check
        id: quality-check
        env:
          BEAST_MODE_API_URL: ${{ secrets.BEAST_MODE_API_URL || 'https://beast-mode.dev' }}
          BEAST_MODE_API_KEY: ${{ secrets.BEAST_MODE_API_KEY }}
        run: |
          # Get PR diff or changed files
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA | grep -E '\.(js|ts|jsx|tsx|py|rs|go)$' || echo "")
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E '\.(js|ts|jsx|tsx|py|rs|go)$' || echo "")
          fi
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "No code files changed, skipping quality check"
            echo "quality_score=100" >> $GITHUB_OUTPUT
            echo "quality_passed=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Call BEAST MODE API for quality analysis
          RESPONSE=$(curl -s -X POST "$BEAST_MODE_API_URL/api/repos/quality" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $BEAST_MODE_API_KEY" \
            -d "{
              \"repo\": \"${{ github.repository }}\",
              \"platform\": \"github\",
              \"pr\": ${{ github.event.pull_request.number || 'null' }},
              \"sha\": \"${{ github.sha }}\",
              \"changedFiles\": [$(echo "$CHANGED_FILES" | sed 's/^/"/;s/$/"/' | tr '\n' ',' | sed 's/,$//')]
            }")
          
          QUALITY_SCORE=$(echo $RESPONSE | jq -r '.quality // .score // 0')
          QUALITY_PASSED=$(echo "$QUALITY_SCORE >= 60" | bc)
          
          echo "quality_score=$QUALITY_SCORE" >> $GITHUB_OUTPUT
          echo "quality_passed=$QUALITY_PASSED" >> $GITHUB_OUTPUT
          echo "Quality Score: $QUALITY_SCORE/100"
      
      - name: Comment PR with Quality Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const qualityScore = ${{ steps.quality-check.outputs.quality_score }};
            const qualityPassed = ${{ steps.quality-check.outputs.quality_passed }};
            
            const emoji = qualityScore >= 80 ? 'ğŸŸ¢' : qualityScore >= 60 ? 'ğŸŸ¡' : 'ğŸ”´';
            const status = qualityPassed ? 'âœ… Passed' : 'âŒ Failed';
            
            const comment = `## ${emoji} BEAST MODE Quality Check
            
            **Quality Score:** ${qualityScore}/100
            **Status:** ${status}
            
            ${qualityPassed ? 'âœ… Code quality meets standards' : 'âš ï¸ Code quality below threshold (60%)'}
            
            ---
            *Powered by [BEAST MODE](https://beast-mode.dev)*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Set Quality Gate Status
        if: steps.quality-check.outputs.quality_passed == 'false'
        run: |
          echo "âŒ Quality check failed (score: ${{ steps.quality-check.outputs.quality_score }})"
          exit 1
